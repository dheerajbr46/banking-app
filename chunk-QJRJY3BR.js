import{e as v,f as S}from"./chunk-O2OYFZXD.js";import{C as c,U,Y as k,ba as b,k as f,o as l,p as i,s as n}from"./chunk-DEEXOUVC.js";var h={production:!0,apiBaseUrl:"https://banking-backend.com/api",useMockAuth:!0};var d="banking-app.token",m="banking-app.user",w="banking-app.mock-users",g=[{id:"user-1",username:"avery",fullName:"Avery Hughes",email:"avery@interactive.bank",password:"banking123",role:"customer"}],E=class u{constructor(e){this.http=e}apiBaseUrl=h.apiBaseUrl;authEndpoint=`${this.apiBaseUrl}/auth`;useMockAuth=h.useMockAuth??!1;mockUsers=this.useMockAuth?this.restoreMockUsers():[];currentUserSubject=new f(this.restoreUser());currentUser$=this.currentUserSubject.asObservable();isAuthenticated$=this.currentUser$.pipe(n(e=>!!e));login(e){let r=e.email.trim().toLowerCase(),s={email:r,password:e.password};if(this.useMockAuth){let t=this.mockUsers.find(a=>a.email.toLowerCase()===r);if(!t||t.password!==e.password)return i(()=>new Error("Invalid email or password."));let o=`mock-token-${t.id??"session"}`;return this.persistSession(o,t),l(this.mapProfile(t))}return this.http.post(`${this.authEndpoint}/login`,s).pipe(U(t=>this.persistSession(t.token,t.user)),n(t=>this.mapProfile(t.user)),c(t=>i(()=>this.normalizeError(t))))}register(e){let r=e.username.trim(),s=e.email.trim().toLowerCase(),t={username:r,fullName:e.name.trim(),email:s,password:e.password};if(this.useMockAuth){let o=r.toLowerCase();if(this.mockUsers.some(p=>p.email.toLowerCase()===s))return i(()=>new Error("Email already registered."));if(this.mockUsers.some(p=>(p.username??"").toLowerCase()===o))return i(()=>new Error("Username already taken."));let a={id:`mock-${Date.now()}`,email:s,username:r,fullName:t.fullName,password:e.password,role:"customer"};return this.mockUsers=[...this.mockUsers,a],this.persistMockUsers(),l(this.mapProfile(a))}return this.http.post(`${this.authEndpoint}/register`,t).pipe(n(o=>this.mapProfile(o.user)),c(o=>i(()=>this.normalizeError(o))))}checkUsernameAvailability(e){let r=e.trim();if(!r)return i(()=>new Error("Username is required"));if(this.useMockAuth){let s=r.toLowerCase(),t=this.mockUsers.some(o=>(o.username??"").toLowerCase()===s);return l(!t)}return this.http.get(`${this.authEndpoint}/username-availability`,{params:{username:r}}).pipe(n(s=>s.available),c(s=>{let t=this.normalizeError(s),o=t.message==="Unable to sign in."?"Unable to verify username.":t.message;return i(()=>new Error(o))}))}logout(){localStorage.removeItem(d),localStorage.removeItem(m),this.currentUserSubject.next(null)}updateSessionProfile(e){localStorage.setItem(m,JSON.stringify(e)),this.currentUserSubject.next(e)}get accessToken(){return localStorage.getItem(d)}get backendApiBase(){return this.apiBaseUrl}persistSession(e,r){let s=this.mapProfile(r);localStorage.setItem(d,e),localStorage.setItem(m,JSON.stringify(s)),this.currentUserSubject.next(s)}restoreUser(){let e=localStorage.getItem(m);if(!e)return null;try{return JSON.parse(e)}catch(r){return console.warn("Failed to restore user session:",r),null}}mapProfile(e){let r=e.id??e.username??e.email,s=e.name??e.fullName??e.username??e.email.split("@")[0];return{id:String(r),name:s,email:e.email}}normalizeError(e){if(e instanceof v){let r=e.error&&typeof e.error=="object"&&"message"in e.error?String(e.error.message):e.message;return new Error(r||"Unable to sign in.")}return e instanceof Error?e:new Error("Unable to sign in.")}restoreMockUsers(){let e=localStorage.getItem(w);if(!e)return[...g];try{let r=JSON.parse(e);return!Array.isArray(r)||!r.length?[...g]:r}catch(r){return console.warn("Failed to parse stored mock users. Falling back to defaults.",r),[...g]}}persistMockUsers(){this.useMockAuth&&localStorage.setItem(w,JSON.stringify(this.mockUsers))}static \u0275fac=function(r){return new(r||u)(b(S))};static \u0275prov=k({token:u,factory:u.\u0275fac,providedIn:"root"})};export{h as a,E as b};
